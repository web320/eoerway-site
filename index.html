# ==========================================
# ğŸ’™ EOERWAY AI Therapy v2.8
# (Default: English, Small Language Toggle Button)
# ==========================================
import os, uuid, json, time, random
from datetime import datetime
from dotenv import load_dotenv
from openai import OpenAI
import streamlit as st
import streamlit.components.v1 as components
import firebase_admin
from firebase_admin import credentials, firestore

# ================= ads.txt =================
if "ads.txt" in st.query_params:
    st.write("google.com, pub-5846666879010880, DIRECT, f08c47fec0942fa0")
    st.stop()

# ================= Config =================
APP_VERSION = "v2.8"
PAYPAL_URL = "https://www.paypal.com/ncp/payment/W6UUT2A8RXZSG"
DAILY_FREE_LIMIT = 7
BASIC_LIMIT = 50
RESET_INTERVAL_HOURS = 4
ADMIN_KEYS = ["4321"]

# ================= OpenAI =================
load_dotenv()
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY") or st.secrets.get("OPENAI_API_KEY")
client = OpenAI(api_key=OPENAI_API_KEY)

# ================= Firebase =================
def _firebase_config():
    raw = st.secrets.get("firebase")
    if raw is None:
        raise RuntimeError("Secretsì— [firebase] ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.")
    if isinstance(raw, str):
        return json.loads(raw)
    return dict(raw)

if not firebase_admin._apps:
    cred = credentials.Certificate(_firebase_config())
    firebase_admin.initialize_app(cred)
db = firestore.client()

# ================= Query Params =================
uid = st.query_params.get("uid", [str(uuid.uuid4())])[0]
st.query_params = {"uid": uid}
USER_ID = uid

# ================= UI Config =================
st.set_page_config(page_title="ğŸ’™ AI Therapy", layout="wide")

# --- ì‘ì€ ì–¸ì–´ ì „í™˜ ë²„íŠ¼ (ê¸°ë³¸ ì˜ì–´) ---
if "lang" not in st.session_state:
    st.session_state["lang"] = "English ğŸ‡ºğŸ‡¸"

col1, col2 = st.columns([5,1])
with col2:
    lang_choice = st.radio(" ", ["English ğŸ‡ºğŸ‡¸", "í•œêµ­ì–´ ğŸ‡°ğŸ‡·"], horizontal=True, label_visibility="collapsed",
                           index=0 if st.session_state["lang"] == "English ğŸ‡ºğŸ‡¸" else 1)
st.session_state["lang"] = lang_choice
language = st.session_state["lang"]

# ================= Text by Language =================
if language == "English ğŸ‡ºğŸ‡¸":
    TEXT = {
        "title": "â¤ï¸ A Warm AI Friend You Can Lean On",
        "free": "ğŸŒ± Free Trial",
        "paid": "ğŸ’ Premium User",
        "input": "How are you feeling right now?",
        "warn": "Please enter something ğŸ’¬",
        "usedup": "ğŸŒ™ Youâ€™ve used all 7 free sessions today!",
        "reset": "â° Free sessions reset! (Every 4 hours)",
        "reply_error": "AI response error",
        "feedback_placeholder": "e.g., The AI felt really comforting ğŸ’•",
        "feedback_sent": "ğŸ’– Feedback saved safely. Thank you!",
        "feedback_empty": "Please write something ğŸ’¬",
        "payment_title": "ğŸ’³ Payment Guide",
        "feedback_title": "ğŸ’Œ Service Feedback",
        "chat_return": "ğŸ’¬ Back to Chat",
        "chat_button": "ğŸ’³ Open Payment & Feedback",
        "status_left": "remaining",
    }
else:
    TEXT = {
        "title": "â¤ï¸ ë§ˆìŒì„ ê¸°ëŒˆ ìˆ˜ ìˆëŠ” ë”°ëœ»í•œ AI ì¹œêµ¬",
        "free": "ğŸŒ± ë¬´ë£Œ ì²´í—˜ì¤‘",
        "paid": "ğŸ’ ìœ ë£Œ ì´ìš©ì¤‘",
        "input": "ì§€ê¸ˆ ì–´ë–¤ ê¸°ë¶„ì´ì˜ˆìš”?",
        "warn": "ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš” ğŸ’¬",
        "usedup": "ğŸŒ™ ì˜¤ëŠ˜ì˜ ë¬´ë£Œ ìƒë‹´ 7íšŒë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”!",
        "reset": "â° ë¬´ë£Œ ìƒë‹´ì´ ë‹¤ì‹œ ê°€ëŠ¥í•´ì¡Œì–´ìš”! (4ì‹œê°„ë§ˆë‹¤ ë³µêµ¬)",
        "reply_error": "AI ì‘ë‹µ ì˜¤ë¥˜",
        "feedback_placeholder": "ì˜ˆ: ìƒë‹´ì´ ì •ë§ ë”°ëœ»í–ˆì–´ìš” ğŸŒ·",
        "feedback_sent": "ğŸ’– í”¼ë“œë°±ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!",
        "feedback_empty": "ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš” ğŸ’¬",
        "payment_title": "ğŸ’³ ê²°ì œ ì•ˆë‚´",
        "feedback_title": "ğŸ’Œ ì„œë¹„ìŠ¤ í”¼ë“œë°±",
        "chat_return": "ğŸ’¬ ëŒ€í™”ì°½ìœ¼ë¡œ ëŒì•„ê°€ê¸°",
        "chat_button": "ğŸ’³ ê²°ì œ ë° í”¼ë“œë°± ì—´ê¸°",
        "status_left": "ë‚¨ì€",
    }

st.title(TEXT["title"])

# ================= CSS =================
st.markdown("""
<style>
html, body, [class*="css"] { font-size: 18px; }
.user-bubble {
  background:#b91c1c;color:#fff;border-radius:14px;padding:10px 18px;margin:8px 0;
  display:inline-block;box-shadow:0 0 10px rgba(255,0,0,0.3);
}
.bot-bubble {
  font-size:21px;line-height:1.8;border-radius:16px;padding:16px 20px;margin:10px 0;
  background:rgba(15,15,30,.85);color:#fff;border:2px solid transparent;
  border-image:linear-gradient(90deg,#ff8800,#ffaa00,#ff8800) 1;
  box-shadow:0 0 12px #ffaa00;animation:neon 1.6s ease-in-out infinite alternate;
}
@keyframes neon {from{box-shadow:0 0 8px #ffaa00;}to{box-shadow:0 0 22px #ffcc33;} }
.status {
  font-size:15px;padding:8px 12px;border-radius:10px;
  display:inline-block;margin-bottom:8px;background:rgba(255,255,255,.06);
}
</style>
""", unsafe_allow_html=True)

# ================= Firestore Defaults =================
defaults = {
    "is_paid": False,
    "usage_count": 0,
    "remaining_paid_uses": 0,
    "last_reset": datetime.utcnow().isoformat()
}
user_ref = db.collection("users").document(USER_ID)
snap = user_ref.get()
if snap.exists:
    data = snap.to_dict() or {}
    st.session_state.update({k: data.get(k, v) for k, v in defaults.items()})
else:
    user_ref.set(defaults)
    st.session_state.update(defaults)

def persist_user(fields: dict):
    user_ref.set(fields, merge=True)
    st.session_state.update(fields)

# ================= AI Response =================
def stream_reply(user_input: str):
    try:
        if language == "English ğŸ‡ºğŸ‡¸":
            system_prompt = (
                "You are a warm and empathetic professional counselor. "
                "Comfort the userâ€™s heart with gentle, moving words in 6â€“9 sentences."
            )
        else:
            system_prompt = (
                "ë„ˆëŠ” ë§ˆìŒì´ ë¬´ì²™ ë”°ëœ»í•˜ê³  ê³µê°ë ¥ ìˆëŠ” ì‹¬ë¦¬ ì „ë¬¸ìƒë‹´ì‚¬ì˜ˆìš”. "
                "ì´ìš©ìì˜ ë§ˆìŒì„ í† ë‹¥ì—¬ì£¼ê³  ë”°ëœ»í•˜ê²Œ ê°ë™ì„ ì£¼ëŠ” ë§ì„ 6~9ë¬¸ì¥ ì •ë„ë¡œ ì´ì•¼ê¸°í•´ì¤˜ìš”. "
                "ëª¨ë“  ë¬¸ì¥ì€ ë°˜ë“œì‹œ â€˜ìš”â€™ë¡œ ëë‚˜ì•¼ í•˜ê³ , ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•´ìš”. "
                "ë¨¼ì € ì´ë ‡ê²Œ ìš©ê¸° ë‚´ì–´ ì´ì•¼ê¸°í•´ì¤˜ì„œ ì •ë§ ê³ ë§ˆì›Œìš”. "
                "ì´ìš©ìì˜ ìƒí™©ì„ ì´í•´í•˜ê³  ë”°ëœ»í•˜ê²Œ ê³µê°í•˜ë©° ìœ„ë¡œì˜ ë§ì„ ê±´ë„¤ì£¼ì„¸ìš”."
            )

        stream = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_input},
            ],
            temperature=0.9,
            max_tokens=700,
            stream=True,
        )

        placeholder = st.empty()
        full_text = ""
        for chunk in stream:
            delta = chunk.choices[0].delta
            if hasattr(delta, "content") and delta.content:
                full_text += delta.content
                placeholder.markdown(f"<div class='bot-bubble'>{full_text}ğŸ’«</div>", unsafe_allow_html=True)
                time.sleep(0.03)

        db.collection("chats").add({
            "uid": USER_ID,
            "input": user_input,
            "reply": full_text.strip(),
            "lang": language,
            "created_at": datetime.utcnow().isoformat()
        })
        return full_text.strip()

    except Exception as e:
        st.error(f"{TEXT['reply_error']}: {e}")
        return None

# ================= Payment =================
def render_payment_and_feedback():
    st.markdown("---")
    st.subheader(TEXT["payment_title"])
    components.html(f"""
    <div style="text-align:center">
      <a href="{PAYPAL_URL}" target="_blank">
        <button style="background:#ffaa00;color:black;padding:12px 20px;border:none;border-radius:10px;font-size:18px;">
          ğŸ’³ PayPal ($3)
        </button>
      </a>
      <p style="opacity:0.9;margin-top:14px;line-height:1.6;font-size:17px;">
      After payment, please send a screenshot to  
      <b style="color:#FFD966;">mwiby91@gmail.com</b> or KakaoTalk ID <b>jeuspo</b> ğŸ’Œ<br>
      ğŸ”’ <b>Once the message is read</b>, your 50-use access will be activated within 1 hour.  
      <br><br>
      ğŸ‡°ğŸ‡· ê²°ì œ í›„ <b style="color:#FFD966;">mwiby91@gmail.com</b> ë˜ëŠ”  
      <b>ì¹´í†¡ ID: jeuspo</b> ë¡œ ìŠ¤í¬ë¦°ìƒ·ì„ ë³´ë‚´ì£¼ì„¸ìš”.<br>
      ë©”ì‹œì§€ë¥¼ í™•ì¸í•œ í›„ 1ì‹œê°„ ì´ë‚´ì— 50íšŒ ì´ìš©ê¶Œì´ í™œì„±í™”ë©ë‹ˆë‹¤. ğŸŒ¸
      </p>
    </div>
    """, height=320)

    st.subheader("ğŸ”‘ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥")
    pw = st.text_input(" ", type="password", placeholder="ê´€ë¦¬ì ì „ìš© ë¹„ë°€ë²ˆí˜¸ ì…ë ¥")
    if pw:
        if pw.strip() in ADMIN_KEYS:
            persist_user({"is_paid": True, "remaining_paid_uses": BASIC_LIMIT})
            st.success("âœ… ì¸ì¦ ì„±ê³µ! 50íšŒ ì´ìš©ê¶Œì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
        else:
            st.error("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")

    st.markdown("---")
    st.subheader(TEXT["feedback_title"])
    fb = st.text_area(" ", placeholder=TEXT["feedback_placeholder"])
    if st.button("ğŸ“© Submit / ë³´ë‚´ê¸°"):
        if not fb.strip():
            st.warning(TEXT["feedback_empty"])
        else:
            db.collection("feedbacks").document(str(uuid.uuid4())).set({
                "uid": USER_ID, "feedback": fb, "lang": language,
                "created_at": datetime.utcnow().isoformat()
            })
            st.success(TEXT["feedback_sent"])

# ================= Chat =================
def render_chat_page():
    if st.session_state.get("is_paid"):
        left = st.session_state.get("remaining_paid_uses", BASIC_LIMIT)
        plan = TEXT["paid"]
    else:
        left = DAILY_FREE_LIMIT - st.session_state["usage_count"]
        plan = TEXT["free"]
    st.markdown(f"<div class='status'>{plan} â€” {TEXT['status_left']} {max(left,0)}íšŒ</div>", unsafe_allow_html=True)

    now = datetime.utcnow()
    last_reset = datetime.fromisoformat(st.session_state.get("last_reset"))
    if (now - last_reset).total_seconds() / 3600 >= RESET_INTERVAL_HOURS:
        persist_user({"usage_count": 0, "last_reset": now.isoformat()})
        st.info(TEXT["reset"])

    usage = st.session_state["usage_count"]
    if not st.session_state.get("is_paid") and usage >= DAILY_FREE_LIMIT:
        st.warning(TEXT["usedup"])
        st.session_state["show_payment"] = True
        st.rerun()

    user_input = st.chat_input(TEXT["input"])
    if not user_input:
        return
    st.markdown(f"<div class='user-bubble'>{user_input}</div>", unsafe_allow_html=True)
    reply = stream_reply(user_input)
    if reply:
        if st.session_state.get("is_paid"):
            persist_user({"remaining_paid_uses": st.session_state.get("remaining_paid_uses", BASIC_LIMIT) - 1})
        else:
            persist_user({"usage_count": usage + 1})

# ================= Sidebar =================
st.sidebar.header("ğŸ“œ History / ëŒ€í™” ê¸°ë¡")
if st.session_state.get("show_payment"):
    if st.sidebar.button(TEXT["chat_return"]):
        st.session_state["show_payment"] = False
        st.rerun()
else:
    if st.sidebar.button(TEXT["chat_button"]):
        st.session_state["show_payment"] = True
        st.rerun()

# ================= Run =================
if st.session_state.get("show_payment"):
    render_payment_and_feedback()
else:
    render_chat_page()
